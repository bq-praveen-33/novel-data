{
  "online_content": {
    "type": "doc",
    "content": [
      {
        "type": "codeBlock",
        "attrs": {
          "language": "typescriptreact"
        },
        "content": [
          {
            "type": "text",
            "text": "\"use client\";\n\nimport React, { useImperativeHandle, useMemo, useRef, forwardRef } from \"react\";\nimport { canEditProperty } from \"../cellEditors/CellEditorRegistry\";\nimport type { Note } from \"@/types/board\";\nimport { postWithAuth } from \"@/lib/api-helpers\";\nimport { toast } from \"sonner\";\n\ninterface PropertyColumnMeta {\n  id: string;\n  name: string;\n  type: string;\n  icon?: React.ReactNode;\n}\n\ninterface SelectionToolbarProps {\n  selectedCount: number;\n  onClearSelection: () => void;\n  properties: PropertyColumnMeta[];\n  onOpenEditor: (propertyId: string, anchorEl: HTMLElement) => void;\n  // Batch context\n  boardId: string;\n  selectedIds: string[];\n  localNotes: Note[];\n  setLocalNotes: (updater: (prev: Note[]) => Note[]) => void;\n  updateNoteInContext: (boardId: string, noteId: string, updated: Note) => void;\n}\n\nexport type SelectionToolbarHandle = {\n  applyBatch: (propertyId: string, value: any) => Promise<void>;\n};\n\nconst SelectionToolbar = forwardRef<SelectionToolbarHandle, SelectionToolbarProps>(\n  ({ selectedCount, onClearSelection, properties, onOpenEditor, boardId, selectedIds, localNotes, setLocalNotes, updateNoteInContext }, ref) => {\n  const containerRef = useRef<HTMLDivElement>(null);\n\n  const actionableProperties = useMemo(\n    () => properties.filter((p) => p.id !== \"title\" && canEditProperty(p.type)),\n    [properties],\n  );\n\n  useImperativeHandle(ref, () => ({\n    applyBatch: async (propertyId: string, value: any) => {\n      if (!selectedIds.length) return;\n\n      const prevById = new Map<string, Note>();\n      localNotes.forEach((n) => {\n        if (selectedIds.includes(n._id)) prevById.set(n._id, n);\n      });\n\n      // Optimistic update\n      setLocalNotes((prev) =>\n        prev.map((n) =>\n          selectedIds.includes(n._id)\n            ? { ...n, databaseProperties: { ...n.databaseProperties, [propertyId]: value } }\n            : n,\n        ),\n      );\n      selectedIds.forEach((id) => {\n        const old = prevById.get(id)!;\n        const updated = { ...old, databaseProperties: { ...old.databaseProperties, [propertyId]: value } } as Note;\n        updateNoteInContext(boardId, id, updated);\n      });\n\n      await Promise.all(\n        selectedIds.map(async (id) => {\n          try {\n            const propType = properties.find((p) => p.id === propertyId)?.type || \"\";\n            const payloadValue = propType === \"person\" ? (Array.isArray(value) ? value : []) : value;\n            const res = await postWithAuth(`/api/database/updatePropertyValue`, {\n              viewId: boardId,\n              pageId: id,\n              propertyId,\n              value: payloadValue,\n            });\n\n            if (!res.success) {\n              const prev = prevById.get(id);\n              if (prev) {\n                setLocalNotes((cur) => cur.map((n) => (n._id === id ? prev : n)));\n                updateNoteInContext(boardId, id, prev);\n              }\n              toast.error(\"Failed to change property value!\");\n              return;\n            }\n\n            const prev = prevById.get(id)!;\n            const serverUpdated: Note = {\n              ...prev,\n              title: res.page.title,\n              databaseProperties: { ...prev.databaseProperties, ...res.page.databaseProperties },\n            };\n            setLocalNotes((cur) => cur.map((n) => (n._id === id ? serverUpdated : n)));\n            updateNoteInContext(boardId, id, serverUpdated);\n          } catch (err) {\n            const prev = prevById.get(id);\n            if (prev) {\n              setLocalNotes((cur) => cur.map((n) => (n._id === id ? prev : n)));\n              updateNoteInContext(boardId, id, prev);\n            }\n            toast.error(\"Could not update property value!\");\n          }\n        }),\n      );\n    },\n  }));\n\n  return (\n    <div\n      ref={containerRef}\n      className=\"sticky top-0 z-[50]\"\n      style={{ background: \"var(--c-bacPri, #ffffff)\", borderBottom: \"1px solid var(--ca-borSecTra, rgba(55,53,47,0.16))\" }}\n      data-selection-toolbar\n    >\n      <div\n        style={{\n          display: \"flex\",\n          alignItems: \"center\",\n          justifyContent: \"space-between\",\n          width: \"100%\",\n          paddingTop: 4,\n          paddingBottom: 4,\n          paddingInline: 8,\n          gap: 8,\n        }}\n      >\n        <div style={{ display: \"flex\", alignItems: \"center\", gap: 12, minWidth: 0, flex: \"1 1 0%\", overflow: \"hidden\" }}>\n          <div style={{ fontWeight: 600, fontSize: 14, color: \"var(--c-texPri)\" }}>{selectedCount} selected</div>\n          <button\n            onClick={onClearSelection}\n            type=\"button\"\n            className=\"text-sm px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800\"\n            aria-label=\"Clear selection\"\n          >\n            Clear\n          </button>\n        </div>\n\n        {/* Property shortcuts */}\n        <div style={{ display: \"flex\", alignItems: \"center\", gap: 6, flexWrap: \"wrap\" }}>\n          {actionableProperties.map((prop) => (\n            <button\n              key={prop.id}\n              type=\"button\"\n              onClick={(e) => onOpenEditor(prop.id, e.currentTarget)}\n              className=\"flex items-center gap-1 text-sm px-2 h-7 rounded hover:bg-gray-100 dark:hover:bg-gray-800\"\n              title={`Edit ${prop.name} for selected`}\n              aria-label={`Edit ${prop.name}`}\n            >\n              <span className=\"w-4 h-4 text-gray-500\">{prop.icon}</span>\n              <span className=\"truncate max-w-[140px]\" style={{ color: \"var(--c-texPri)\" }}>{prop.name}</span>\n            </button>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n});\n\nexport default SelectionToolbar;\n\n\n"
          }
        ]
      }
    ]
  },
  "online_content_time": "2025-11-03T12:54:09.272Z"
}